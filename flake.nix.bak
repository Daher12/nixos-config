{
  description = "Unified NixOS Configuration (Yoga + Latitude)";

  inputs = {
    # Base channels
    nixpkgs.url = "github:nixos/nixpkgs/nixos-25.11";
    nixpkgs-unstable.url = "github:nixos/nixpkgs/nixos-unstable";
    
    # Hardware profiles
    nixos-hardware.url = "github:NixOS/nixos-hardware/master";

    # Secure Boot tooling
    lanzaboote = {
      url = "github:nix-community/lanzaboote/v0.4.3";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    # Home Manager (as a NixOS module)
    home-manager = {
      url = "github:nix-community/home-manager/release-25.11";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    # WinApps (Nix packaging provided by upstream)
    winapps = {
      url = "github:winapps-org/winapps";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = inputs@{ self, nixpkgs, nixpkgs-unstable, lanzaboote, home-manager, winapps, ... }:
    let
      system = "x86_64-linux";
      
      # 1. Overlay Strategy
      mkPkgs = pkgsInput: import pkgsInput {
        inherit system;
        config.allowUnfree = true;
      };
      pkgsUnstable = mkPkgs nixpkgs-unstable;

      # Make unstable available as pkgs.unstable everywhere
      unstableOverlay = final: prev: {
        unstable = pkgsUnstable;
      };

      pkgs = import nixpkgs {
        inherit system;
        overlays = [ unstableOverlay ];
        config.allowUnfree = true;
      };

      palette = import ./lib/palette.nix;

      # 2. Shared Arguments (Passed to every module)
      sharedArgs = {
        inherit inputs palette;
        pkgs-unstable = pkgsUnstable;
        unstable = pkgsUnstable;  # Alias for modules expecting 'unstable'
        winapps = inputs.winapps; # Needed for home/winapps.nix
      };

    in
    {
      formatter.${system} = pkgs.nixfmt-rfc-style;

      nixosConfigurations = {
        
        # --- Host: Yoga ---
        yoga = nixpkgs.lib.nixosSystem {
          inherit system;
          specialArgs = sharedArgs;
          modules = [
            # Global Overlay
            ({ ... }: {
              nixpkgs.overlays = [ unstableOverlay ];
              nixpkgs.config.allowUnfree = true;
            })

            # Core Modules
            lanzaboote.nixosModules.lanzaboote
            home-manager.nixosModules.home-manager
            inputs.nixos-hardware.nixosModules.lenovo-yoga-7-slim-gen8

            # Host Config
            ./hosts/yoga/default.nix

            # Home Manager Config
            {
              home-manager = {
                useGlobalPkgs = true;
                useUserPackages = true;
                backupFileExtension = "backup";
                extraSpecialArgs = sharedArgs;
                users.dk = import ./hosts/yoga/home.nix;
              };
            }
          ];
        };

        # --- Host: Latitude ---
        "e7450-nixos" = nixpkgs.lib.nixosSystem {
          inherit system;
          specialArgs = sharedArgs;
          modules = [
            # Global Overlay
            ({ ... }: {
              nixpkgs.overlays = [ unstableOverlay ];
              nixpkgs.config.allowUnfree = true;
            })

            # Core Modules
            lanzaboote.nixosModules.lanzaboote
            home-manager.nixosModules.home-manager
            # (No nixos-hardware module for this specific Latitude, using local config)

            # Host Config
            ./hosts/latitude/configuration.nix

            # Home Manager Config
            {
              home-manager = {
                useGlobalPkgs = true;
                useUserPackages = true;
                backupFileExtension = "backup";
                extraSpecialArgs = sharedArgs;
                users.dk = import ./hosts/latitude/home.nix;
              };
            }
          ];
        };

      };
    };
}
