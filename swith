# Yoga Impermanence + Disko Deployment

**Pre-requisites:**
- Backup `/home/dk` (Documents, Downloads, .ssh, .gnupg, browser profiles)
- Note WiFi credentials (will configure manually first boot)
- USB installer: NixOS 25.11 minimal ISO

---

## Phase 1: Boot Installer & Partition

```bash
# Boot USB, become root
sudo -i

# Set temporary password for disk encryption (will prompt)
# WARNING: This passphrase encrypts ALL data
nix run github:nix-community/disko -- \
  --mode destroy,format,mount \
  --flake github:daher12/nixos-config#yoga

# Verify mounts
mount | grep -E '(boot|btrfs|cryptroot)'
# Expected:
# /dev/mapper/cryptroot on / type btrfs (subvol=@)
# /dev/mapper/cryptroot on /nix type btrfs (subvol=@nix)
# /dev/mapper/cryptroot on /persist type btrfs (subvol=@persist)
# /dev/nvme0n1p1 on /boot type vfat
```

---

## Phase 2: Install System

```bash
# Clone config (or use GitHub directly)
nixos-install --flake github:daher12/nixos-config#yoga

# Set root password when prompted
# Set dk password when prompted

# DO NOT REBOOT YET
```

---

## Phase 3: Pre-Reboot Setup (Critical)

```bash
# Enter new system chroot
nixos-enter

# Create persist structure
mkdir -p /persist/home/dk/{Documents,Downloads,.ssh,.gnupg}
chown -R 1000:1000 /persist/home/dk
chmod 700 /persist/home/dk

# Copy SSH keys from backup USB (if mounted at /mnt/backup)
cp -a /mnt/backup/.ssh /persist/home/dk/
chown -R 1000:1000 /persist/home/dk/.ssh
chmod 600 /persist/home/dk/.ssh/*

# Initialize SOPS (age method)
mkdir -p /var/lib/sops-nix
# If using age: place your admin key at /var/lib/sops-nix/key.txt
# If using SSH: host key will be auto-derived on first boot

# Exit chroot
exit

# Reboot
reboot
```

---

## Phase 4: First Boot

```bash
# Login as dk
# Verify impermanence is active:
mount | grep btrfs
# Should show @ as empty, all data in @persist

# Check persistence:
ls -la ~  # Should be sparse (only links to /persist)
cat /etc/machine-id  # Should match /persist/system/etc/machine-id

# Configure WiFi manually (until SOPS secrets are active)
nmcli device wifi connect "FRITZ!Box G" password "YOUR_PASS"

# Enable Tailscale
sudo tailscale up

# Verify NAS mount
ls /mnt/nas
```

---

## Phase 5: SOPS & Secrets

```bash
# If SOPS fails to decrypt (missing key):
# Option A: Age key
sudo cp /path/to/backup/age.key /var/lib/sops-nix/key.txt
sudo chown root:root /var/lib/sops-nix/key.txt
sudo chmod 400 /var/lib/sops-nix/key.txt

# Option B: SSH-derived (already works if host key persisted)
# No action needed

# Rebuild to activate secrets
sudo nixos-rebuild switch --flake ~/nixos-config#yoga

# Verify WiFi connections now appear
nmcli connection show
```

---

## Phase 6: Secure Boot (Optional)

```bash
# Only if features.secureboot.enable = true
sudo sbctl create-keys
sudo sbctl enroll-keys --microsoft

# Sign bootloader
sudo nixos-rebuild switch --flake ~/nixos-config#yoga
sudo sbctl verify

# Reboot and enable Secure Boot in BIOS
```

---

## Verification Checklist

```bash
# Persistence active
findmnt -t btrfs
# → @ mounted on /, @persist on /persist, @nix on /nix

# Root wipe working
ls -la /etc | grep -v persist
# → Most files should be ephemeral (e.g., resolv.conf)

# Home persistence
ls ~/.ssh
# → Should show keys from /persist/home/dk/.ssh

# Secrets decrypted
systemctl status NetworkManager
nmcli connection show  # WiFi profiles present

# VM works (if enabled)
sudo virsh net-list --all  # default network active
```

---

## Rollback Strategy

If boot fails or impermanence causes issues:

```bash
# Boot USB again
sudo -i

# Mount and disable impermanence
cryptsetup open /dev/nvme0n1p2 cryptroot
mount -t btrfs -o subvol=@ /dev/mapper/cryptroot /mnt
mount -t btrfs -o subvol=@nix /dev/mapper/cryptroot /mnt/nix
mount -t btrfs -o subvol=@persist /dev/mapper/cryptroot /mnt/persist
mount /dev/nvme0n1p1 /mnt/boot

# Edit config
nano /mnt/persist/home/dk/nixos-config/hosts/yoga/default.nix
# Set: features.impermanence.enable = false;

# Rebuild
nixos-install --flake /mnt/persist/home/dk/nixos-config#yoga --no-root-passwd

# Reboot
```

---

**VERIFY before proceeding:** Disko will **destroy all data** on `/dev/nvme0n1`. Confirm backups exist.
