name: "Maintain: Update Flake Lock"

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update-and-verify:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            accept-flake-config = true
            experimental-features = nix-command flakes
            # Suppress cachix warnings by pre-allowing substituters
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
            substituters = https://cache.nixos.org https://nix-community.cachix.org

      # Skip cachix-action entirelyâ€”substituters already configured above
      
      - name: Update Flake Inputs
        id: update
        run: |
          nix flake update --accept-flake-config
          echo "nixpkgs_rev=$(nix flake metadata --json | jq -r '.locks.nodes.nixpkgs.locked.rev[0:7]')" >> $GITHUB_OUTPUT

      - name: Verify Configurations
        run: |
          nix flake check --all-systems --impure --keep-going
          for host in yoga latitude nix-media; do
            nix build .#nixosConfigurations.$host.config.system.build.toplevel --dry-run --impure
          done

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(flake): update inputs\n\nnixpkgs: ${{ steps.update.outputs.nixpkgs_rev }}"
          file_pattern: flake.lock
